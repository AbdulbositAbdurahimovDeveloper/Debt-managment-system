<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transaction Manager - Create</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .form-section { display: none; }
        .active { display: block; }
        input, select, textarea {
            border: 1px solid #d1d5db;
            padding: 0.5rem;
            border-radius: 0.375rem;
            width: 100%;
        }
        input:focus { outline: 2px solid #3b82f6; border-color: transparent; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8">

<div class="max-w-4xl mx-auto bg-white shadow-lg rounded-lg overflow-hidden">
    <!-- Header: API Settings -->
    <div class="bg-blue-600 p-6 text-white">
        <h1 class="text-2xl font-bold mb-4">Transaction Yaratish (Post Request)</h1>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label class="block text-sm opacity-80">Host (IP:Port)</label>
                <input type="text" id="apiHost" value="localhost:8080" class="text-black">
            </div>
            <div>
                <label class="block text-sm opacity-80">Path</label>
                <input type="text" id="apiPath" value="/api/transactions" class="text-black">
            </div>
            <div>
                <label class="block text-sm opacity-80">JWT Token</label>
                <input type="text" id="jwtToken" placeholder="Bearer eyJhbG..." class="text-black">
            </div>
        </div>
    </div>

    <form id="transactionForm" class="p-6 space-y-6">
        <!-- Asosiy Maydonlar -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label class="block font-medium mb-1">Mijoz ID (Client ID) *</label>
                <input type="number" name="clientId" required>
            </div>
            <div>
                <label class="block font-medium mb-1">Tranzaksiya Turi (Type) *</label>
                <select name="type" id="typeSelect" onchange="toggleSections()" required>
                    <option value="SALE">SALE (Sotuv)</option>
                    <option value="PAYMENT">PAYMENT (Mijozdan to'lov)</option>
                    <option value="RETURN">RETURN (Vozvrat - Mahsulot)</option>
                    <option value="RETURN_PAYMENT">RETURN_PAYMENT (Pulni qaytarish)</option>
                    <option value="PURCHASE">PURCHASE (Taminotchidan yuk olish)</option>
                    <option value="PURCHASE_PAYMENT">PURCHASE_PAYMENT (Taminotchiga to'lov)</option>
                    <option value="TRANSFER">TRANSFER (P2P o'tkazma)</option>
                </select>
            </div>
            <div>
                <label class="block font-medium mb-1">Valyuta (Currency) *</label>
                <select name="transactionCurrency" required>
                    <option value="USD">USD</option>
                    <option value="UZS">UZS</option>
                    <option value="AED">AED</option>
                </select>
            </div>
            <div>
                <label class="block font-medium mb-1">Market Rate (1 USD = ? TC) *</label>
                <input type="number" step="0.0001" name="marketRate" value="12800" required>
            </div>
            <div>
                <label class="block font-medium mb-1">Mijoz Kursi (Client Rate) *</label>
                <input type="number" step="0.0001" name="clientRate" value="1" required>
            </div>
            <div>
                <label class="block font-medium mb-1">Xizmat Haqi (Fee Amount - USD/TC)</label>
                <input type="number" step="0.01" name="feeAmount" value="0">
            </div>
        </div>

        <!-- Dinamik Section: PAYMENT variantlari uchun -->
        <div id="amountSection" class="form-section">
            <label class="block font-medium mb-1 text-blue-600">To'lov Summasi (Amount) *</label>
            <input type="number" step="0.01" name="amount" id="amountInput" placeholder="Pul summasini kiriting">
        </div>

        <!-- Dinamik Section: TRANSFER uchun -->
        <div id="transferSection" class="form-section border-t pt-4">
            <h3 class="font-bold text-lg mb-2 text-purple-600">Transfer Ma'lumotlari</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block font-medium mb-1 text-sm">Oluvchi ID (Receiver ID) *</label>
                    <input type="number" name="receiverClientId" id="receiverIdInput">
                </div>
                <div>
                    <label class="block font-medium mb-1 text-sm">Oluvchi Kursi (Receiver Rate) *</label>
                    <input type="number" step="0.0001" name="receiverRate" id="receiverRateInput" value="1">
                </div>
            </div>
        </div>

        <!-- Dinamik Section: ITEMS (SALE, RETURN, PURCHASE uchun) -->
        <div id="itemsSection" class="form-section border-t pt-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg text-green-600">Mahsulotlar (Items)</h3>
                <button type="button" onclick="addItemRow()" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 text-sm">+ Mahsulot Qo'shish</button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                    <tr class="bg-gray-200">
                        <th class="p-2 border text-sm">Product ID</th>
                        <th class="p-2 border text-sm">Quantity</th>
                        <th class="p-2 border text-sm">Unit Price (TC)</th>
                        <th class="p-2 border"></th>
                    </tr>
                    </thead>
                    <tbody id="itemsTableBody">
                    <!-- Rows go here -->
                    </tbody>
                </table>
            </div>
        </div>

        <div>
            <label class="block font-medium mb-1">Izoh (Description)</label>
            <textarea name="description" rows="2" placeholder="Tranzaksiya haqida qo'shimcha ma'lumot..."></textarea>
        </div>

        <div class="flex gap-4">
            <button type="submit" class="flex-1 bg-blue-700 text-white font-bold py-3 rounded-lg hover:bg-blue-800 transition">REQUEST JO'NATISH</button>
            <button type="button" onclick="generatePreview()" class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600">JSON PREVIEW</button>
        </div>
    </form>

    <!-- Response Window -->
    <div id="responseContainer" class="hidden p-6 border-t bg-gray-50">
        <h3 class="font-bold mb-2">Server Response:</h3>
        <pre id="jsonResponse" class="bg-black text-green-400 p-4 rounded overflow-x-auto text-sm"></pre>
    </div>
</div>

<script>
    // Formani yuklanganda sale bo'lib turadi
    window.onload = () => toggleSections();

    function toggleSections() {
        const type = document.getElementById('typeSelect').value;
        const itemsTypes = ['SALE', 'RETURN', 'PURCHASE'];
        const paymentTypes = ['PAYMENT', 'PURCHASE_PAYMENT', 'RETURN_PAYMENT', 'TRANSFER'];

        // Hamma sectionlarni yopish
        document.getElementById('itemsSection').classList.remove('active');
        document.getElementById('amountSection').classList.remove('active');
        document.getElementById('transferSection').classList.remove('active');

        if (itemsTypes.includes(type)) {
            document.getElementById('itemsSection').classList.add('active');
            if (document.getElementById('itemsTableBody').children.length === 0) addItemRow();
        }

        if (paymentTypes.includes(type)) {
            document.getElementById('amountSection').classList.add('active');
        }

        if (type === 'TRANSFER') {
            document.getElementById('transferSection').classList.add('active');
        }
    }

    function addItemRow() {
        const tbody = document.getElementById('itemsTableBody');
        const row = document.createElement('tr');
        row.className = "item-row";
        row.innerHTML = `
                <td class="p-2 border"><input type="number" class="productId" required></td>
                <td class="p-2 border"><input type="number" class="quantity" value="1" required></td>
                <td class="p-2 border"><input type="number" step="0.01" class="unitPrice" placeholder="Auto"></td>
                <td class="p-2 border text-center">
                    <button type="button" onclick="this.parentElement.parentElement.remove()" class="text-red-500 font-bold">X</button>
                </td>
            `;
        tbody.appendChild(row);
    }

    function collectData() {
        const formData = new FormData(document.getElementById('transactionForm'));
        const data = Object.fromEntries(formData.entries());
        const type = data.type;

        // List-to-Number conversions
        data.clientId = parseInt(data.clientId);
        data.marketRate = parseFloat(data.marketRate);
        data.clientRate = parseFloat(data.clientRate);
        data.feeAmount = parseFloat(data.feeAmount || 0);

        // Amount field
        if (data.amount) data.amount = parseFloat(data.amount);

        // Transfer logic
        if (type === 'TRANSFER') {
            data.receiverClient = { id: parseInt(data.receiverClientId) };
            data.receiverRate = parseFloat(data.receiverRate);
            delete data.receiverClientId;
        } else {
            delete data.receiverClientId;
            delete data.receiverRate;
        }

        // Items logic
        if (['SALE', 'RETURN', 'PURCHASE'].includes(type)) {
            data.items = [];
            document.querySelectorAll('.item-row').forEach(row => {
                const productId = row.querySelector('.productId').value;
                const quantity = row.querySelector('.quantity').value;
                const unitPrice = row.querySelector('.unitPrice').value;
                if (productId) {
                    data.items.push({
                        productId: parseInt(productId),
                        quantity: parseInt(quantity),
                        unitPrice: unitPrice ? parseFloat(unitPrice) : null
                    });
                }
            });
        } else {
            data.items = null;
        }

        return data;
    }

    function generatePreview() {
        const data = collectData();
        document.getElementById('responseContainer').classList.remove('hidden');
        document.getElementById('jsonResponse').textContent = JSON.stringify(data, null, 2);
    }

    document.getElementById('transactionForm').onsubmit = async (e) => {
        e.preventDefault();
        const data = collectData();

        const host = document.getElementById('apiHost').value;
        const path = document.getElementById('apiPath').value;
        const token = document.getElementById('jwtToken').value;
        const url = `http://${host}${path}`;

        document.getElementById('responseContainer').classList.remove('hidden');
        document.getElementById('jsonResponse').textContent = "Jo'natilmoqda...";

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token.startsWith('Bearer ') ? token : `Bearer ${token}`
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            document.getElementById('jsonResponse').textContent = JSON.stringify(result, null, 2);
            if(response.ok) alert("Muvaffaqiyatli!");
            else alert("Xatolik: " + (result.message || "Server error"));

        } catch (error) {
            document.getElementById('jsonResponse').textContent = "ERROR: " + error.message;
        }
    };
</script>
</body>
</html>