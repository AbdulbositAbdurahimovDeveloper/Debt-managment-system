<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <title>Transaction Manager</title>
    <style>
        body { font-family: sans-serif; background: #f4f4f9; padding: 20px; }
        .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .section { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        label { display: block; margin-top: 10px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 8px; margin-top: 5px; box-sizing: border-box; }
        .hidden { display: none; }
        .item-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: flex-end; }
        .item-row div { flex: 1; }
        button { background: #28a745; color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 4px; margin-top: 10px; }
        button.add-btn { background: #007bff; }
        button.remove-btn { background: #dc3545; padding: 8px; }
        pre { background: #eee; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>

<div class="container">
    <h2>Transaction Yaratish</h2>

    <div class="section" style="background: #e9ecef;">
        <label>Bearer Token (JWT)</label>
        <input type="text" id="token" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
    </div>

    <form id="transactionForm">
        <div class="section">
            <label>Mijoz (Client)</label>
            <select id="clientId" required>
                <option value="7">Mohid Mirza</option>
                <option value="4">Abduqodir</option>
                <option value="3">Saxiy Ahmad</option>
                <option value="11">Preview</option>
                <option value="2">Dilnoza opa</option>
                <option value="13">Komil aka</option>
                <option value="9">Micro zone</option>
                <option value="8">Transworld</option>
                <option value="6">Jawel</option>
                <option value="12">Arcada</option>
            </select>

            <label>Tranzaksiya Turi</label>
            <select id="type" onchange="toggleFields()" required>
                <option value="SALE">SALE (Sotish)</option>
                <option value="PURCHASE">PURCHASE (Sotib olish)</option>
                <option value="RETURN">RETURN (Qaytarish)</option>
                <option value="CASH_IN">CASH_IN (Pul olish)</option>
                <option value="CASH_OUT">CASH_OUT (Pul berish)</option>
                <option value="TRANSFER">TRANSFER (O'tkazma)</option>
            </select>
        </div>

        <div class="section">
            <label>To'lov Valyutasi (transactionCurrency)</label>
            <select id="transactionCurrency">
                <option value="USD">USD</option>
                <option value="UZS">UZS</option>
                <option value="AED">AED</option>
            </select>

            <label>Summa (Amount)</label>
            <input type="number" id="amount" step="0.01" placeholder="0.00">

            <label>USD Kursi (rateToUsd)</label>
            <input type="number" id="rateToUsd" step="0.0001" value="1" placeholder="Masalan: 12800">

            <label>Mijoz Balans Kursi (clientRateToUsd)</label>
            <input type="number" id="clientRateToUsd" step="0.0001" value="1">
        </div>

        <div id="transferFields" class="hidden section" style="background: #fff3cd;">
            <label>Qabul qiluvchi (Receiver Client)</label>
            <select id="receiverClientId">
                <option value="4">Abduqodir</option>
                <option value="7">Mohid Mirza</option>
            </select>
            <label>Qabul qiluvchi Kursi (receiverRateToUsd)</label>
            <input type="number" id="receiverRateToUsd" step="0.0001" value="1">
        </div>

        <div id="feeField" class="hidden section">
            <label>Xizmat haqi (Fee Amount - USD)</label>
            <input type="number" id="feeAmount" step="0.01" value="0">
        </div>

        <div id="itemsSection" class="section">
            <label>Mahsulotlar (Items)</label>
            <div id="itemsContainer">
                <div class="item-row">
                    <div>Product ID <input type="number" class="p-id"></div>
                    <div>Soni <input type="number" class="p-qty"></div>
                    <div>Narxi <input type="number" class="p-price" step="0.01"></div>
                    <button type="button" class="remove-btn" onclick="this.parentElement.remove()">X</button>
                </div>
            </div>
            <button type="button" class="add-btn" onclick="addItem()">+ Mahsulot qo'shish</button>
        </div>

        <div class="section">
            <label>Izoh (Description)</label>
            <textarea id="description" rows="2"></textarea>
        </div>

        <button type="submit" style="width: 100%; font-size: 1.2em;">POST Zapros Jo'natish</button>
    </form>

    <h3>Natija:</h3>
    <pre id="response">Zapros kutilmoqda...</pre>
</div>

<script>
    function toggleFields() {
        const type = document.getElementById('type').value;
        const itemsSection = document.getElementById('itemsSection');
        const transferFields = document.getElementById('transferFields');
        const feeField = document.getElementById('feeField');

        // Mahsulotlar bo'limi faqat SALE, PURCHASE, RETURN uchun
        itemsSection.className = (['SALE', 'PURCHASE', 'RETURN'].includes(type)) ? 'section' : 'hidden';

        // Transfer maydonlari
        transferFields.className = (type === 'TRANSFER') ? 'section' : 'hidden';

        // Fee faqat CASH_OUT va TRANSFER uchun
        feeField.className = (type === 'CASH_OUT' || type === 'TRANSFER') ? 'section' : 'hidden';
    }

    function addItem() {
        const div = document.createElement('div');
        div.className = 'item-row';
        div.innerHTML = `
            <div>Product ID <input type="number" class="p-id"></div>
            <div>Soni <input type="number" class="p-qty"></div>
            <div>Narxi <input type="number" class="p-price" step="0.01"></div>
            <button type="button" class="remove-btn" onclick="this.parentElement.remove()">X</button>
        `;
        document.getElementById('itemsContainer').appendChild(div);
    }

    document.getElementById('transactionForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const token = document.getElementById('token').value;
        const type = document.getElementById('type').value;

        // Mahsulotlarni yig'ish
        const items = [];
        if (['SALE', 'PURCHASE', 'RETURN'].includes(type)) {
            document.querySelectorAll('.item-row').forEach(row => {
                items.push({
                    productId: row.querySelector('.p-id').value,
                    quantity: row.querySelector('.p-qty').value,
                    unitPrice: row.querySelector('.p-price').value
                });
            });
        }

        const payload = {
            clientId: document.getElementById('clientId').value,
            receiverClientId: type === 'TRANSFER' ? document.getElementById('receiverClientId').value : null,
            type: type,
            transactionCurrency: document.getElementById('transactionCurrency').value,
            amount: document.getElementById('amount').value,
            rateToUsd: document.getElementById('rateToUsd').value,
            clientRateToUsd: document.getElementById('clientRateToUsd').value,
            receiverRateToUsd: type === 'TRANSFER' ? document.getElementById('receiverRateToUsd').value : null,
            feeAmount: document.getElementById('feeAmount').value,
            description: document.getElementById('description').value,
            items: items.length > 0 ? items : null,
            createdAt: new Date().toISOString()
        };

        try {
            const response = await fetch('http://localhost:8080/api/v1/transaction', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            document.getElementById('response').innerText = JSON.stringify(result, null, 2);
        } catch (error) {
            document.getElementById('response').innerText = "Xatolik: " + error.message;
        }
    });

    // Boshlang'ich holatni sozlash
    toggleFields();
</script>

</body>
</html>